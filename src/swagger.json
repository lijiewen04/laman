{
  "openapi": "3.0.1",
  "info": {
    "title": "个人项目",
    "description": "",
    "version": "1.0.0"
  },
  "tags": [{ "name": "Auth" }, { "name": "Patient" }, { "name": "File" }, { "name": "System" }],
  "paths": {
    "/api/auth/create-user": {
      "post": {
        "summary": "超级管理员创建用户",
        "deprecated": false,
        "description": "仅超级管理员可用。请求体含 username, optional password, userPermission, department, phone。返回新建用户信息及明文密码（仅返回一次）。",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/CreateUserRequest" }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "创建结果",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/CreateUserResponse" }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/admin-update-user": {
      "post": {
        "summary": "超级管理员修改用户资料",
        "deprecated": false,
        "description": "仅超级管理员可用。请求体含 id 和要更新的字段（username/userPermission/department/phone）。",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/AdminUpdateUserRequest" }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新结果",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AdminUpdateUserResponse" }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/reset-password": {
      "post": {
        "summary": "超级管理员重置用户密码（随机生成）",
        "deprecated": false,
        "description": "仅超级管理员可用。请求体 { id }，返回新的临时密码（明文，仅显示一次）",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ResetPasswordRequest" }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "重置结果",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ResetPasswordResponse" }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/login": {
      "post": {
        "summary": "用户登录",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LoginRequest"
              },
              "examples": {}
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "登录结果（返回 token）",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/AuthLoginResponse" }
              }
            },
            "headers": {}
          },
          "x-200-2": {
            "description": "备用响应",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/AuthLoginResponse" } } },
            "headers": {}
          }
        },
        "security": []
      }
    },
    "/api/auth/me": {
      "post": {
        "summary": "获取当前用户信息",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "responses": {
          "200": {
            "description": "当前用户信息",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthMeResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/user-list": {
      "post": {
        "summary": "获取用户列表（管理员/超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/AuthUserListQuery" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "用户列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthUserListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/profile": {
      "post": {
        "summary": "更新当前用户资料",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateProfileRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthProfileResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/update-permission": {
      "post": {
        "summary": "更新指定用户权限（超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdatePermissionRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新权限结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthUpdatePermissionResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/auth/delete": {
      "post": {
        "summary": "删除用户（超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Auth", "Auth"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DeleteUserRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "删除结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthDeleteUserResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/create": {
      "post": {
        "summary": "创建病人（管理员/超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PatientCreate"
              },
              "examples": {}
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "创建结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientCreateResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/list": {
      "post": {
        "summary": "获取病人列表",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PatientListQuery"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "病人列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/detail": {
      "post": {
        "summary": "获取病人详情",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/GetDetailRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "病人详情",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientDetailResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/update": {
      "post": {
        "summary": "更新病人信息（管理员/超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdatePatientRequest"
              },
              "examples": {}
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "更新结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientUpdateResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/delete": {
      "post": {
        "summary": "删除病人（超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DeletePatientRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "删除结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientDeleteResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/groups": {
      "post": {
        "summary": "获取分组列表",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "responses": {
          "200": {
            "description": "分组列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientGroupsResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/patient/statistics": {
      "post": {
        "summary": "获取统计数据",
        "deprecated": false,
        "description": "",
        "tags": ["Patient", "Patient"],
        "parameters": [],
        "responses": {
          "200": {
            "description": "统计数据",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PatientStatisticsResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/upload": {
      "post": {
        "summary": "文件上传（管理员/超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": {
                    "type": "string",
                    "format": "binary",
                    "example": ""
                  },
                  "patientId": {
                    "type": "integer",
                    "description": "关联的病人 ID，必填"
                  },
                  "fileType": {
                    "type": "string",
                    "example": ""
                  },
                  "description": {
                    "type": "string",
                    "example": ""
                  }
                },
                "required": ["file", "patientId"]
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "上传结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FileUploadResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/download": {
      "post": {
        "summary": "文件下载（管理员/超级管理员/用户）",
        "deprecated": false,
        "description": "使用 POST 请求，传入 { id }，并在 `Authorization` 头中携带 `Bearer <token>`。",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DownloadRequest"
              },
              "examples": {}
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "二进制文件流（成功）",
            "content": {
              "application/octet-stream": {
                "schema": { "$ref": "#/components/schemas/FileDownloadSuccess" }
              }
            },
            "headers": {}
          },
          "x-200-2": {
            "description": "失败返回 JSON",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/FileDownloadError" } } },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/list": {
      "post": {
        "summary": "获取文件列表",
        "deprecated": false,
        "description": "",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/FileListQuery"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "文件列表和分页信息",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FileListResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/preview": {
      "post": {
        "summary": "获取文件预览",
        "deprecated": false,
        "description": "",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/FilePreviewRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "预览数据（JSON）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FilePreviewResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/detail": {
      "post": {
        "summary": "根据文件 id 获取文件信息及对应病人详情",
        "deprecated": false,
        "description": "请求体: { id }，返回 data: { file: FileInfo, patient: PatientListItem }",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/DownloadRequest" }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "文件信息与病人详情",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/FileWithPatientResponse" }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/types": {
      "post": {
        "summary": "获取文件类型列表",
        "deprecated": false,
        "description": "",
        "tags": ["File", "File"],
        "parameters": [],
        "responses": {
          "200": {
            "description": "文件类型列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FileTypesResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/delete": {
      "post": {
        "summary": "删除文件（超级管理员）",
        "deprecated": false,
        "description": "",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/DeleteFileRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "删除结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FileDeleteResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/authorize-download": {
      "post": {
        "summary": "授权访客下载（超级管理员）",
        "deprecated": false,
        "description": "管理员可以直接为指定用户授权下载，或者处理访客提交的下载申请（批准/拒绝）。两种合法用法：1) 直接授权：提供 `fileId` 与 `userId`；2) 处理申请：提供 `requestId` 与 `action`（`approve` 或 `reject`）。",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/AuthorizeDownloadRequest"
              },
              "examples": {
                "directAuthorize": {
                  "summary": "直接为用户授权",
                  "value": { "fileId": 123, "userId": 456, "expiresIn": 24 }
                },
                "processRequest": {
                  "summary": "处理访客的下载申请（批准）",
                  "value": { "requestId": 789, "action": "approve", "expiresIn": 48 }
                }
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "授权结果或处理结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/AuthorizeDownloadResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/health": {
      "post": {
        "summary": "健康检查",
        "deprecated": false,
        "description": "",
        "tags": ["System", "System"],
        "parameters": [],
        "responses": {
          "200": {
            "description": "服务状态",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/HealthResponse"
                }
              }
            },
            "headers": {}
          }
        },
        "security": []
      }
    },
    "/api/file/request-download": {
      "post": {
        "summary": "访客提交下载申请",
        "deprecated": false,
        "description": "仅访客用户可提交下载申请；其他用户调用返回 '无需请求权限'。请求体 { fileId, message? }。",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RequestDownloadRequest" }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "提交结果",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/RequestDownloadResponse" },
                "examples": {
                  "success": {
                    "summary": "提交成功",
                    "value": {
                      "status": 0,
                      "msg": "提交申请成功",
                      "data": {
                        "id": 123,
                        "fileId": 10,
                        "userId": 45,
                        "username": "visitor1",
                        "message": "请批准",
                        "status": "pending",
                        "createdAt": "2025-11-26T12:00:00Z"
                      }
                    }
                  },
                  "already_pending": {
                    "summary": "已有未处理申请",
                    "value": {
                      "status": 4007,
                      "msg": "已有下载申请",
                      "data": null
                    }
                  },
                  "already_approved": {
                    "summary": "已被批准，不能再次申请",
                    "value": {
                      "status": 4007,
                      "msg": "申请已经批准",
                      "data": null
                    }
                  },
                  "recently_rejected": {
                    "summary": "被拒且需等待",
                    "value": {
                      "status": 4007,
                      "msg": "申请被拒绝，请02-30后重试",
                      "data": null,
                      "retryAfterSeconds": 9000
                    }
                  }
                }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    },
    "/api/file/request-list": {
      "post": {
        "summary": "超级管理员获取下载申请列表",
        "deprecated": false,
        "description": "仅超级管理员可用。支持分页与按状态/文件/用户筛选。",
        "tags": ["File", "File"],
        "parameters": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RequestListRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "申请列表",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/RequestListResponse" }
              }
            },
            "headers": {}
          }
        },
        "security": [{ "bearerAuth": [] }]
      }
    }
  },
  "components": {
    "schemas": {
      "BaseResponse": {
        "type": "object",
        "properties": {
          "status": { "type": "integer", "example": 0 },
          "msg": { "type": "string", "example": "成功" }
        }
      },
      "UserPermission": {
        "type": "string",
        "enum": ["访客", "用户", "管理员", "超级管理员"],
        "description": "用户权限类型枚举"
      },
      "AuthRegisterResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "token": { "type": "string" },
                  "user": {
                    "type": "object",
                    "properties": {
                      "id": { "type": "integer" },
                      "username": { "type": "string" },
                      "userPermission": { "$ref": "#/components/schemas/UserPermission" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "AuthLoginResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": { "type": "string", "description": "JWT token" }
            }
          }
        ]
      },
      "AuthMeResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "id": { "type": "integer" },
                  "username": { "type": "string" },
                  "userPermission": { "$ref": "#/components/schemas/UserPermission" },
                  "department": { "type": "string" },
                  "phone": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "AuthUserListResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "id": { "type": "integer" },
                        "username": { "type": "string" },
                        "userPermission": { "$ref": "#/components/schemas/UserPermission" },
                        "department": { "type": "string" },
                        "phone": { "type": "string" }
                      }
                    }
                  },
                  "pagination": {
                    "type": "object",
                    "properties": {
                      "page": { "type": "integer" },
                      "limit": { "type": "integer" },
                      "total": { "type": "integer" },
                      "totalPages": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "AuthProfileResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "nullable": true,
                "properties": {
                  "username": { "type": "string" },
                  "userPermission": { "$ref": "#/components/schemas/UserPermission" },
                  "department": { "type": "string" },
                  "phone": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "AuthUpdatePermissionResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "nullable": true,
                "properties": {
                  "id": { "type": "integer" },
                  "username": { "type": "string" },
                  "userPermission": { "$ref": "#/components/schemas/UserPermission" }
                }
              }
            }
          }
        ]
      },
      "AuthDeleteUserResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "nullable": true, "type": "object" } } }
        ]
      },
      "LoginRequest": {
        "type": "object",
        "properties": {
          "username": {
            "type": "string"
          },
          "password": {
            "type": "string"
          }
        },
        "required": ["username", "password"]
      },
      "RegisterRequest": {
        "type": "object",
        "properties": {
          "username": {
            "type": "string"
          },
          "password": {
            "type": "string"
          },
          "department": {
            "type": "string",
            "default": "访客",
            "description": "注册时默认部门为 访客，可由用户提交修改"
          },
          "phone": {
            "type": "string"
          }
        },
        "required": ["username", "password"]
      },
      "PatientCreateResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "$ref": "#/components/schemas/PatientListItem" } } }
        ]
      },
      "PatientListResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "items": { "type": "array", "items": { "$ref": "#/components/schemas/PatientListItem" } },
                  "pagination": {
                    "type": "object",
                    "properties": {
                      "page": { "type": "integer" },
                      "limit": { "type": "integer" },
                      "total": { "type": "integer" },
                      "totalPages": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "PatientDetailResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "$ref": "#/components/schemas/PatientListItem" } } }
        ]
      },
      "PatientUpdateResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "type": "object", "nullable": true } } }
        ]
      },
      "PatientDeleteResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "nullable": true, "type": "object" } } }
        ]
      },
      "PatientGroupsResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "groups": { "type": "array", "items": { "type": "string" } }
                }
              }
            }
          }
        ]
      },
      "PatientStatisticsResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "total": { "type": "integer" },
                  "tested": { "type": "integer" },
                  "inpatient": { "type": "integer" },
                  "outpatient": { "type": "integer" }
                }
              }
            }
          }
        ]
      },
      "FileInfo": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "filename": { "type": "string" },
          "originalName": { "type": "string" },
          "mimeType": { "type": "string" },
          "size": { "type": "integer" },
          "fileType": { "type": "string" },
          "description": { "type": "string" },
          "metadata": {
            "oneOf": [{ "type": "object", "additionalProperties": true }, { "type": "string" }],
            "description": "文件元数据，可能为对象或 JSON 字符串"
          },
          "patientId": { "type": "integer" },
          "patientName": { "type": "string" },
          "downloadCount": { "type": "integer" },
          "createdAt": { "type": "string", "format": "date-time" },
          "uploadedBy": { "type": "integer" },
          "uploadedByUsername": { "type": "string" },
          "importedTable": { "type": "string" }
          ,"hasPermission": { "type": "boolean", "description": "当前用户是否有权限访问/下载此文件（非访客始终 true；访客根据授权判断）" }
        }
      },
      "FileUploadResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "$ref": "#/components/schemas/FileInfo" } } }
        ]
      },
      "FileWithPatientResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "file": { "$ref": "#/components/schemas/FileInfo" },
                  "patient": { "$ref": "#/components/schemas/PatientListItem" }
                }
              }
            }
          }
        ]
      },
      "FileDownloadSuccess": {
        "type": "string",
        "format": "binary",
        "description": "Binary file stream"
      },
      "FileDownloadError": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "type": "object", "nullable": true } } }
        ]
      },
      "FileListResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "files": {
                    "type": "array",
                    "items": { "$ref": "#/components/schemas/FileInfo" }
                  },
                  "pagination": {
                    "type": "object",
                    "properties": {
                      "page": { "type": "integer" },
                      "limit": { "type": "integer" },
                      "total": { "type": "integer" },
                      "totalPages": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "FilePreviewResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "preview": {
                    "type": "array",
                    "nullable": true,
                    "items": { "type": "object", "additionalProperties": true }
                  },
                  "totalRows": { "type": "integer" },
                  "fileType": { "type": "string" },
                  "source": { "type": "string" },
                  "sheetName": { "type": "string" },
                  "totalSheets": { "type": "integer" },
                  "message": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "FileTypesResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "items": { "type": "array", "items": { "type": "string" } },
                  "pagination": {
                    "type": "object",
                    "properties": {
                      "page": { "type": "integer" },
                      "limit": { "type": "integer" },
                      "total": { "type": "integer" },
                      "totalPages": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "FileDeleteResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          { "properties": { "data": { "type": "object", "nullable": true } } }
        ]
      },
      "AuthorizeDownloadResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "username": { "type": "string" },
                  "fileId": { "type": "integer" },
                  "expiresAt": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        ]
      },
      "HealthResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": { "type": "object", "properties": { "timestamp": { "type": "string", "format": "date-time" } } }
            }
          }
        ]
      },
      "UpdateProfileRequest": {
        "type": "object",
        "properties": {
          "username": {
            "type": "string"
          },
          "department": {
            "type": "string"
          },
          "phone": {
            "type": "string"
          }
        }
      },
      "UpdatePermissionRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "用户 ID（用于标识要修改权限的用户）"
          },
          "userPermission": { "$ref": "#/components/schemas/UserPermission" }
        },
        "required": ["id", "userPermission"]
      },
      "DeleteUserRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "要删除的用户 ID"
          }
        },
        "required": ["id"]
      },
      "PatientCreate": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "serialNo": {
            "type": "string"
          },
          "abbr": {
            "type": "string"
          },
          "time": {
            "type": "integer"
          },
          "inpatientOutpatient": {
            "type": "string",
            "enum": ["住院", "门诊"]
          },
          "group": {
            "type": "string"
          },
          "gender": {
            "type": "string"
          },
          "age": {
            "type": "integer"
          },
          "caseNo": {
            "type": "string"
          },
          "diagnosis": {
            "type": "string"
          },
          "isTested": {
            "type": "boolean"
          },
          "preTreatment": {
            "type": "boolean"
          },
          "treatmentType": {
            "type": "string"
          },
          "memo": {
            "type": "string"
          }
        },
        "required": ["name", "serialNo"]
      },
      "PatientListQuery": {
        "type": "object",
        "properties": {
          "page": {
            "type": "integer",
            "default": 1
          },
          "limit": {
            "type": "integer",
            "default": 20
          },
          "name": {
            "type": "string"
          },
          "serialNo": {
            "type": "string"
          },
          "inpatientOutpatient": {
            "type": "string"
          },
          "isTested": {
            "type": "boolean"
          },
          "diagnosis": {
            "type": "string"
          },
          "group": {
            "type": "string"
          },
          "abbr": { "type": "string" },
          "gender": { "type": "string", "description": "男/女/未知/其他" },
          "ageMin": { "type": "integer", "description": "年龄下限（包含）" },
          "ageMax": { "type": "integer", "description": "年龄上限（包含）" },
          "caseNo": { "type": "string" },
          "tStage": { "type": "string" },
          "nStage": { "type": "string" },
          "mStage": { "type": "string" },
          "stage": { "type": "string" },
          "preTreatment": { "type": "boolean" },
          "treatmentType": { "type": "string" },
          "memo": { "type": "string" },
          "createdBy": { "type": "integer", "description": "创建者用户ID" },
          "timeStart": { "type": "string", "description": "起始时间（ISO 或 与数据库一致的格式）" },
          "timeEnd": { "type": "string", "description": "结束时间（ISO 或 与数据库一致的格式）" }
        }
      },
      "AuthUserListQuery": {
        "type": "object",
        "properties": {
          "page": { "type": "integer", "default": 1 },
          "limit": { "type": "integer", "default": 20 },
          "username": { "type": "string", "description": "按用户名模糊搜索" },
          "department": { "type": "string", "description": "按科室/部门模糊搜索" },
          "userPermission": {
            "$ref": "#/components/schemas/UserPermission",
            "description": "按权限精确匹配（例如：超级管理员/管理员/访客）"
          },
          "phone": { "type": "string", "description": "按电话号码模糊搜索" },
          "createdAtStart": { "type": "string", "description": "创建时间起始（ISO）" },
          "createdAtEnd": { "type": "string", "description": "创建时间结束（ISO）" },
          "isActive": { "type": "boolean", "description": "是否只返回激活用户；未提供则默认为 true" }
        }
      },
      "PatientListItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "abbr": {
            "type": "string"
          },
          "time": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "serialNo": {
            "type": "string"
          },
          "inpatientOutpatient": {
            "type": "string"
          },
          "group": {
            "type": "string",
            "nullable": true
          },
          "gender": {
            "type": "string"
          },
          "age": {
            "type": "integer"
          },
          "caseNo": {
            "type": "string"
          },
          "diagnosis": {
            "type": "string"
          },
          "isTested": {
            "type": "boolean"
          },
          "tStage": {
            "type": "string",
            "nullable": true
          },
          "nStage": {
            "type": "string",
            "nullable": true
          },
          "mStage": {
            "type": "string",
            "nullable": true
          },
          "stage": {
            "type": "string",
            "nullable": true
          },
          "preTreatment": {
            "type": "boolean"
          },
          "treatmentType": {
            "type": "string",
            "nullable": true
          },
          "memo": {
            "type": "string",
            "nullable": true
          }
        }
      },
      "GetDetailRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          }
        },
        "required": ["id"]
      },
      "UpdatePatientRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "serialNo": {
            "type": "string"
          },
          "abbr": {
            "type": "string"
          },
          "time": {
            "type": "integer"
          },
          "inpatientOutpatient": {
            "type": "string",
            "enum": ["住院", "门诊"]
          },
          "group": {
            "type": "string"
          },
          "gender": {
            "type": "string"
          },
          "age": {
            "type": "integer"
          },
          "caseNo": {
            "type": "string"
          },
          "diagnosis": {
            "type": "string"
          },
          "isTested": {
            "type": "boolean"
          },
          "preTreatment": {
            "type": "boolean"
          },
          "treatmentType": {
            "type": "string"
          },
          "memo": {
            "type": "string"
          }
        },
        "required": ["id"]
      },
      "DeletePatientRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          }
        },
        "required": ["id"]
      },
      "FileUpload": {
        "type": "object",
        "properties": {
          "file": {
            "type": "string",
            "format": "binary"
          },
          "patientId": { "type": "integer", "description": "关联的病人 ID" },
          "fileType": {
            "type": "string"
          },
          "description": {
            "type": "string"
          }
        },
        "required": ["file", "patientId"]
      },
      "DownloadRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          }
        },
        "required": ["id"]
      },
      "FileListQuery": {
        "type": "object",
        "properties": {
          "page": {
            "type": "integer",
            "default": 1
          },
          "limit": {
            "type": "integer",
            "default": 20
          },
          "patientId": { "type": "integer", "description": "按病人 ID 过滤" },
          "fileType": {
            "type": "string"
          },
          "uploadedBy": {
            "type": "string"
          },
          "uploadedById": { "type": "integer", "description": "按上传者用户ID过滤" },
          "mimeType": { "type": "string" },
          "minSize": { "type": "integer", "description": "最小文件大小（字节）" },
          "maxSize": { "type": "integer", "description": "最大文件大小（字节）" },
          "description": { "type": "string" },
          "createdAtStart": { "type": "string", "description": "创建时间起始（ISO）" },
          "createdAtEnd": { "type": "string", "description": "创建时间结束（ISO）" },
          "filename": {
            "type": "string"
          },
          "originalName": {
            "type": "string"
          }
        }
      },
      "FilePreviewRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "limit": {
            "type": "integer",
            "default": 10
          }
        },
        "required": ["id"]
      },
      "DeleteFileRequest": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          }
        },
        "required": ["id"]
      },
      "AuthorizeDownloadRequest": {
        "type": "object",
        "description": "两种合法用法：1) 直接授权：提供 `fileId` 与 `userId`；2) 处理访客申请：提供 `requestId` 与 `action`（'approve' 或 'reject'）。",
        "properties": {
          "fileId": {
            "type": "integer",
            "description": "目标文件 ID（用于直接授权）"
          },
          "userId": {
            "type": "integer",
            "description": "目标用户的 ID（用于直接授权，仅接受 userId）"
          },
          "requestId": {
            "type": "integer",
            "description": "下载申请的 ID（用于处理访客申请）"
          },
          "action": {
            "type": "string",
            "description": "当使用 requestId 时，action 必须为 'approve' 或 'reject'",
            "enum": ["approve", "reject"]
          },
          "expiresIn": {
            "type": "integer",
            "description": "授权时长（小时），默认 24"
          }
        }
      },
      "RequestDownloadRequest": {
        "type": "object",
        "properties": {
          "fileId": { "type": "integer" },
          "message": { "type": "string", "description": "申请说明，可选" }
        },
        "required": ["fileId"]
      },
      "RequestDownloadResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "nullable": true,
                "properties": {
                  "id": { "type": "integer" },
                  "fileId": { "type": "integer" },
                  "userId": { "type": "integer" },
                  "username": { "type": "string" },
                  "message": { "type": "string" },
                  "status": { "type": "string" },
                  "createdAt": { "type": "string", "format": "date-time" }
                }
              }
            }
          }
        ]
      },
      "RequestListRequest": {
        "type": "object",
        "properties": {
          "page": { "type": "integer", "default": 1 },
          "limit": { "type": "integer", "default": 20 },
          "status": { "type": "string" },
          "fileId": { "type": "integer" },
          "userId": { "type": "integer" },
          "patientName": { "type": "string", "description": "按患者姓名模糊搜索" },
          "patientGroup": { "type": "string", "description": "按患者分组精确匹配" }
        }
      },
      "RequestListResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "items": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "id": { "type": "integer" },
                        "fileId": { "type": "integer" },
                        "userId": { "type": "integer" },
                        "username": { "type": "string" },
                        "message": { "type": "string" },
                        "status": { "type": "string" },
                        "createdAt": { "type": "string", "format": "date-time" },
                        "filename": { "type": "string" },
                        "originalName": { "type": "string" },
                        "patientName": { "type": "string" },
                        "patientGroup": { "type": "string" },
                        "patientId": { "type": "integer" },
                        "patientSerialNo": { "type": "string" }
                      }
                    }
                  },
                  "pagination": {
                    "type": "object",
                    "properties": {
                      "page": { "type": "integer" },
                      "limit": { "type": "integer" },
                      "total": { "type": "integer" },
                      "totalPages": { "type": "integer" }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "CreateUserRequest": {
        "type": "object",
        "properties": {
          "username": { "type": "string" },
          "password": { "type": "string", "description": "可选，不提供则自动生成" },
          "userPermission": { "type": "string", "description": "访客/用户/管理员/超级管理员" },
          "department": { "type": "string" },
          "phone": { "type": "string" }
        },
        "required": ["username"]
      },
      "CreateUserResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "user": { "$ref": "#/components/schemas/AuthMeResponse" },
                  "password": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "AdminUpdateUserRequest": {
        "type": "object",
        "properties": {
          "id": { "type": "integer" },
          "username": { "type": "string" },
          "userPermission": { "type": "string" },
          "department": { "type": "string" },
          "phone": { "type": "string" }
        },
        "required": ["id"]
      },
      "AdminUpdateUserResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "id": { "type": "integer" },
                  "username": { "type": "string" },
                  "userPermission": { "type": "string" },
                  "department": { "type": "string" },
                  "phone": { "type": "string" }
                }
              }
            }
          }
        ]
      },
      "ResetPasswordRequest": {
        "type": "object",
        "properties": { "id": { "type": "integer" } },
        "required": ["id"]
      },
      "ResetPasswordResponse": {
        "type": "object",
        "allOf": [
          { "$ref": "#/components/schemas/BaseResponse" },
          {
            "properties": {
              "data": {
                "type": "object",
                "properties": {
                  "id": { "type": "integer" },
                  "username": { "type": "string" },
                  "newPassword": { "type": "string" }
                }
              }
            }
          }
        ]
      }
    },
    "securitySchemes": {
      "bearerAuth": { "type": "http", "scheme": "bearer", "bearerFormat": "JWT" }
    }
  },
  "servers": []
}
